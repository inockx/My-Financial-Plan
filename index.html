<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#f3f4f6">
    <title>My Money Plan</title>
    
    <!-- Google Fonts: Sarabun -->
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js for Graphs -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Phosphor Icons -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <style>
        /* Changed Font to Sarabun */
        body {
            font-family: 'Sarabun', sans-serif;
            -webkit-tap-highlight-color: transparent;
            min-height: 100vh;
            background-color: #f3f4f6;
        }

        /* --- DYNAMIC THEME VARIABLES --- */
        :root {
            /* Main Theme (Default: Blue) */
            --theme-main: #2563eb;   /* 600 */
            --theme-light: #3b82f6;  /* 500 */
            --theme-dark: #1d4ed8;   /* 700 */
            --theme-shadow: #bfdbfe; /* 200 */
            --theme-faint: #dbeafe;  /* 100 */

            /* Semantic Colors (Income/Expense) */
            --color-income: #16a34a;    /* green-600 */
            --color-income-bg: #dcfce7; /* green-100 */
            --color-expense: #ef4444;   /* red-500 */
            --color-expense-bg: #fee2e2;/* red-100 */
        }
        
        /* Card Styling */
        .ios-card {
            background: white;
            border-radius: 16px; /* Slightly reduced radius for mobile */
            box-shadow: 0 2px 10px rgba(0,0,0,0.03);
            border: 1px solid rgba(0,0,0,0.02);
        }

        /* Hiding Scrollbars */
        .scroll-hide::-webkit-scrollbar { display: none; }
        .scroll-hide { -ms-overflow-style: none; scrollbar-width: none; }

        /* Bottom Navigation Active State */
        .nav-item { transition: color 0.2s ease; }
        .nav-item.active { color: var(--theme-main); }
        .nav-item.active i { font-weight: bold; }

        /* Animations */
        @keyframes slide-up { from { transform: translateY(100%); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .animate-slide-up { animation: slide-up 0.3s cubic-bezier(0.16, 1, 0.3, 1); }

        @keyframes fade-in { from { opacity: 0; } to { opacity: 1; } }
        .animate-fade-in { animation: fade-in 0.2s ease-out; }
        
        @keyframes pop-in { from { transform: translate(-50%, -50%) scale(0.95); opacity: 0; } to { transform: translate(-50%, -50%) scale(1); opacity: 1; } }
        .animate-pop-in { animation: pop-in 0.2s cubic-bezier(0.16, 1, 0.3, 1); }

        /* Safe Area Spacing */
        .safe-top { padding-top: max(12px, env(safe-area-inset-top)); }
        .safe-bottom { padding-bottom: max(70px, env(safe-area-inset-bottom)); } /* Reduced slightly */
        .safe-pb { padding-bottom: env(safe-area-inset-bottom); }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden text-gray-800">

    <!-- HEADER -->
    <header class="bg-white px-4 pb-3 shadow-sm z-10 safe-top flex-none">
        <div class="flex justify-between items-center mt-1">
            <div>
                <!-- Editable Title ID -->
                <h1 id="appTitleDisplay" class="text-xl font-extrabold tracking-tight text-gray-900">Money Plan</h1>
                <p class="text-[10px] font-medium text-gray-500 uppercase tracking-wide" id="currentDateDisplay">Loading...</p>
            </div>
            <div class="flex items-center gap-2">
                <!-- Settings Button -->
                <button onclick="openSettings()" class="w-9 h-9 flex items-center justify-center rounded-full hover:bg-gray-100 text-gray-400 hover:text-gray-600 transition-colors">
                    <i class="ph ph-gear text-lg"></i>
                </button>
                <!-- Trash Button -->
                <button onclick="triggerClearMonth()" class="w-9 h-9 flex items-center justify-center rounded-full hover:bg-red-50 text-gray-400 hover:text-[var(--color-expense)] transition-colors">
                    <i class="ph ph-trash text-lg"></i>
                </button>
            </div>
        </div>
    </header>

    <!-- MAIN CONTENT AREA -->
    <!-- Reduced padding (p-3) and spacing (space-y-4) for mobile fit -->
    <main id="mainContainer" class="flex-1 overflow-y-auto scroll-hide p-3 safe-bottom space-y-4">
        
        <!-- DASHBOARD VIEW -->
        <div id="view-dashboard" class="space-y-4 animate-fade-in">
            
            <!-- Summary Card -->
            <div class="ios-card p-4 text-white shadow-lg" style="background: linear-gradient(to bottom right, var(--theme-main), var(--theme-light)); box-shadow: 0 8px 20px -5px var(--theme-shadow);">
                <!-- Header Row: Label & Selector -->
                <div class="flex justify-between items-center mb-2">
                    <p class="text-white/80 text-[10px] font-bold uppercase tracking-wider">This Month Leftover</p>
                    <select id="monthSelector" onchange="changeMonth()" class="text-white text-xs font-bold rounded-lg px-2 py-1 border-none focus:ring-0 cursor-pointer transition-colors backdrop-blur-sm" style="background-color: rgba(0,0,0,0.2);">
                        <!-- Options filled by JS -->
                    </select>
                </div>

                <!-- Big Balance Number (Reduced size) -->
                <h2 class="text-3xl font-bold mb-4 tracking-tight" id="dashLeftover">0</h2>

                <!-- Month Income/Expense -->
                <div class="grid grid-cols-2 gap-2 pb-3 border-b border-white/20">
                    <div>
                        <div class="flex items-center gap-1 text-white/90 mb-0.5">
                            <i class="ph ph-arrow-circle-down text-base"></i>
                            <span class="text-[10px] font-bold uppercase">Income</span>
                        </div>
                        <p class="font-bold text-base" id="dashIncome">0</p>
                    </div>
                    <div class="text-right">
                        <div class="flex items-center justify-end gap-1 text-white/90 mb-0.5">
                            <span class="text-[10px] font-bold uppercase">Fixed Costs</span>
                            <i class="ph ph-arrow-circle-up text-base"></i>
                        </div>
                        <p class="font-bold text-base" id="dashExpenses">0</p>
                    </div>
                </div>

                <!-- Total All Time -->
                <div class="pt-3 flex justify-between items-center">
                    <span class="text-white/90 text-xs font-medium">Total Balance (All Time)</span>
                    <span class="text-white font-bold text-lg" id="dashTotalBalance">0</span>
                </div>
            </div>

            <!-- Chart -->
            <div class="ios-card p-3">
                <div class="flex justify-between items-center mb-2">
                    <h3 class="text-xs font-bold text-gray-900 flex items-center gap-1.5">
                        <i class="ph ph-chart-bar" style="color: var(--theme-light)"></i> Trend
                    </h3>
                    
                    <!-- Chart Filters -->
                    <div class="flex gap-1.5">
                        <select id="chartFilterRange" onchange="renderChart()" class="bg-gray-100 text-[10px] font-bold rounded px-1.5 py-1 border-none outline-none text-gray-700 focus:ring-1" style="--tw-ring-color: var(--theme-main);">
                            <!-- Populated by JS -->
                        </select>
                        <select id="chartFilterType" onchange="renderChart()" class="bg-gray-100 text-[10px] font-bold rounded px-1.5 py-1 border-none outline-none text-gray-700 focus:ring-1" style="--tw-ring-color: var(--theme-main);">
                            <option value="both">Both</option>
                            <option value="income">Income</option>
                            <option value="expense">Expense</option>
                        </select>
                    </div>
                </div>
                
                <div class="h-36 relative w-full">
                    <canvas id="trendChart"></canvas>
                </div>
            </div>

            <!-- Transaction List (Preview) -->
            <div>
                <div class="flex justify-between items-center mb-2 px-1">
                    <h3 class="text-gray-900 font-bold text-sm">Top Expenses</h3>
                    <button onclick="switchTab('list')" class="text-[10px] font-bold hover:bg-gray-50 px-2 py-1 rounded-lg transition-colors uppercase" style="color: var(--theme-main);">See All</button>
                </div>
                <div id="dashboardList" class="space-y-2">
                    <!-- List Items -->
                </div>
            </div>
        </div>

        <!-- LIST VIEW -->
        <div id="view-list" class="hidden space-y-3 animate-fade-in">
            <!-- Sticky Filter Header -->
            <div class="sticky top-0 bg-[#f3f4f6] z-10 pt-1 pb-2 space-y-2">
                <div class="flex justify-between items-center">
                    <h2 class="text-xl font-bold text-gray-900">Records</h2>
                    <!-- Add New Button -->
                    <button onclick="openModal()" class="text-white px-3 py-1.5 rounded-full text-xs font-bold shadow-md active:scale-95 transition-all flex items-center gap-1.5" style="background-color: var(--theme-main); box-shadow: 0 4px 6px -1px var(--theme-shadow);">
                        <i class="ph ph-plus-bold"></i> Add
                    </button>
                </div>
                
                <!-- Search Bar -->
                <div class="relative">
                    <i class="ph ph-magnifying-glass absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 text-base"></i>
                    <input type="text" id="searchInput" placeholder="Search..."
                           class="w-full bg-white border border-gray-200 rounded-xl pl-9 pr-4 py-2 text-sm outline-none text-gray-700 font-medium shadow-sm transition-shadow focus:ring-2"
                           style="--tw-ring-color: var(--theme-main);"
                           oninput="renderList()">
                </div>

                <!-- Filter Bar -->
                <div class="flex gap-2">
                    <div class="flex-1">
                        <label class="sr-only">Date</label>
                        <input type="month" id="filterDate" class="w-full bg-white border border-gray-200 rounded-lg px-2 py-1.5 text-xs outline-none text-gray-700 font-bold focus:ring-1" style="--tw-ring-color: var(--theme-main);" onchange="applyListFilters()">
                    </div>
                    <div class="flex-1">
                        <label class="sr-only">Type</label>
                        <select id="filterType" class="w-full bg-white border border-gray-200 rounded-lg px-2 py-1.5 text-xs outline-none text-gray-700 font-bold appearance-none focus:ring-1" style="--tw-ring-color: var(--theme-main);" onchange="applyListFilters()">
                            <option value="all">All Types</option>
                            <option value="income">Income Only</option>
                            <option value="expense">Expenses Only</option>
                        </select>
                    </div>
                </div>
            </div>
            
            <div id="fullList" class="space-y-2 pb-20">
                <!-- All Items -->
            </div>
        </div>

    </main>

    <!-- BOTTOM NAVIGATION -->
    <nav class="bg-white/95 backdrop-blur-md border-t border-gray-200 flex justify-around items-center pt-2 fixed bottom-0 w-full z-20 safe-pb shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.02)]">
        <button onclick="switchTab('dashboard')" class="nav-item active flex flex-col items-center w-full py-2 text-gray-400" id="nav-dash">
            <i class="ph ph-chart-pie-slice text-2xl mb-0.5"></i>
            <span class="text-[10px] font-bold">Overview</span>
        </button>
        <button onclick="switchTab('list')" class="nav-item flex flex-col items-center w-full py-2 text-gray-400" id="nav-list">
            <i class="ph ph-list-dashes text-2xl mb-0.5"></i>
            <span class="text-[10px] font-bold">Records</span>
        </button>
    </nav>

    <!-- SETTINGS MODAL -->
    <div id="settingsModal" class="fixed inset-0 z-50 hidden">
        <div class="absolute inset-0 bg-black/40 backdrop-blur-sm transition-opacity" onclick="closeSettings()"></div>
        <div class="absolute bottom-0 sm:top-1/2 sm:left-1/2 sm:-translate-x-1/2 sm:-translate-y-1/2 w-full sm:w-80 bg-white rounded-t-3xl sm:rounded-3xl p-5 animate-slide-up shadow-2xl">
            <div class="flex justify-between items-center mb-5">
                <h3 class="text-lg font-bold text-gray-900">App Settings</h3>
                <button onclick="closeSettings()" class="bg-gray-100 p-1.5 rounded-full text-gray-500 hover:bg-gray-200 transition-colors">
                    <i class="ph ph-x text-lg"></i>
                </button>
            </div>
            
            <form onsubmit="saveSettings(event)" class="space-y-5">
                <!-- Title Edit -->
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1.5 ml-1">App Title</label>
                    <input type="text" id="settingsTitle" placeholder="Money Plan" class="w-full bg-gray-50 border border-gray-200 rounded-xl p-3 outline-none transition-all font-medium text-gray-800 text-sm focus:ring-2" style="--tw-ring-color: var(--theme-main);">
                </div>

                <!-- Theme Select -->
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-2 ml-1">Theme Color</label>
                    <div class="grid grid-cols-6 gap-2" id="themeSelectorGrid">
                        <!-- Filled by JS -->
                    </div>
                </div>

                <!-- CSV Import Section -->
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-2 ml-1">Import Data</label>
                    <div class="relative">
                        <input type="file" id="csvFileInput" accept=".csv" class="hidden" onchange="handleCSVUpload(event)">
                        <button type="button" onclick="document.getElementById('csvFileInput').click()" class="w-full bg-gray-100 text-gray-700 font-bold py-3 rounded-xl active:scale-95 transition-transform hover:bg-gray-200 flex items-center justify-center gap-2 text-sm border border-gray-200">
                            <i class="ph ph-upload-simple text-lg"></i> Import CSV
                        </button>
                        <!-- Updated Help Text -->
                        <p class="text-[10px] text-gray-400 mt-1 ml-1">Format: YYYY-MM; Subject; Price (e.g. 2025-12; Car; -3000)</p>
                    </div>
                </div>

                <!-- Save Settings Button -->
                <button type="submit" class="w-full text-white font-bold py-3.5 rounded-xl active:scale-95 transition-transform shadow-lg flex items-center justify-center gap-2 text-sm" style="background-color: var(--theme-main); box-shadow: 0 4px 6px -1px var(--theme-shadow);">
                    <i class="ph ph-check-circle text-lg"></i> Save Settings
                </button>
            </form>
        </div>
    </div>

    <!-- RECORD EDIT MODAL -->
    <div id="modal" class="fixed inset-0 z-50 hidden">
        <div class="absolute inset-0 bg-black/40 backdrop-blur-sm transition-opacity" onclick="closeModal()"></div>
        <div class="absolute bottom-0 sm:top-1/2 sm:left-1/2 sm:-translate-x-1/2 sm:-translate-y-1/2 w-full sm:w-96 bg-white rounded-t-3xl sm:rounded-3xl p-5 animate-slide-up shadow-2xl max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-5">
                <h3 class="text-lg font-bold text-gray-900" id="modalTitle">Edit Record</h3>
                <button onclick="closeModal()" class="bg-gray-100 p-1.5 rounded-full text-gray-500 hover:bg-gray-200 transition-colors">
                    <i class="ph ph-x text-lg"></i>
                </button>
            </div>
            
            <form onsubmit="saveTransaction(event)" class="space-y-3.5">
                <input type="hidden" id="editId">
                
                <div class="grid grid-cols-2 gap-3">
                    <div class="col-span-2">
                        <label class="block text-[10px] font-bold text-gray-500 uppercase mb-1 ml-1">Date (Month)</label>
                        <input type="month" id="inputDate" required class="w-full bg-gray-50 border border-gray-200 rounded-xl p-3 outline-none transition-all font-medium text-gray-800 text-sm focus:ring-2" style="--tw-ring-color: var(--theme-main);">
                    </div>
                    
                    <div class="col-span-2">
                        <label class="block text-[10px] font-bold text-gray-500 uppercase mb-1 ml-1">Name / Description</label>
                        <input type="text" id="inputDesc" list="descSuggestions" placeholder="e.g. Grocery" required 
                               class="w-full bg-gray-50 border border-gray-200 rounded-xl p-3 outline-none transition-all font-medium placeholder-gray-400 text-sm focus:ring-2"
                               style="--tw-ring-color: var(--theme-main);"
                               oninput="autoFillCategory(this)">
                        <datalist id="descSuggestions">
                            <!-- Populated by JS -->
                        </datalist>
                    </div>
                    
                    <div class="col-span-2">
                        <label class="block text-[10px] font-bold text-gray-500 uppercase mb-1 ml-1">Category</label>
                        <input type="text" id="inputCategory" placeholder="e.g. Food, Utilities" class="w-full bg-gray-50 border border-gray-200 rounded-xl p-3 outline-none transition-all font-medium placeholder-gray-400 text-sm focus:ring-2" style="--tw-ring-color: var(--theme-main);">
                    </div>

                    <div class="col-span-2 bg-gray-50 p-3 rounded-xl border border-dashed border-gray-300">
                        <label class="block text-[10px] font-bold text-gray-500 uppercase mb-1.5 ml-1">Period (Optional)</label>
                        <div class="flex items-center gap-2">
                            <input type="number" id="inputInstCurrent" placeholder="1" min="1" class="w-full bg-white border border-gray-200 rounded-lg p-2 outline-none text-center font-bold text-sm focus:ring-2" style="--tw-ring-color: var(--theme-main);">
                            <span class="text-gray-400 text-xs font-bold">OF</span>
                            <input type="number" id="inputInstTotal" placeholder="Total" min="1" class="w-full bg-white border border-gray-200 rounded-lg p-2 outline-none text-center font-bold text-sm focus:ring-2" style="--tw-ring-color: var(--theme-main);">
                        </div>
                        <p class="text-[10px] text-gray-500 mt-2 ml-1 hidden" id="autoGenHint">
                            <i class="ph ph-magic-wand" style="color: var(--theme-main);"></i> Will generate <span id="genCount">0</span> future records automatically.
                        </p>
                    </div>

                    <div>
                        <label class="block text-[10px] font-bold text-gray-500 uppercase mb-1 ml-1">Amount</label>
                        <input type="number" id="inputAmount" placeholder="0" required class="w-full bg-gray-50 border border-gray-200 rounded-xl p-3 outline-none transition-all font-medium placeholder-gray-400 text-sm focus:ring-2" style="--tw-ring-color: var(--theme-main);">
                    </div>
                    <div>
                        <label class="block text-[10px] font-bold text-gray-500 uppercase mb-1 ml-1">Type</label>
                        <select id="inputType" class="w-full bg-gray-50 border border-gray-200 rounded-xl p-3 outline-none transition-all font-medium appearance-none text-sm focus:ring-2" style="--tw-ring-color: var(--theme-main);">
                            <option value="expense">Expense</option>
                            <option value="income">Income</option>
                        </select>
                    </div>
                </div>

                <div class="flex gap-2 pt-2">
                    <button type="button" id="deleteBtn" onclick="triggerDelete()" class="hidden flex-1 bg-red-100 font-bold py-3.5 rounded-xl active:scale-95 transition-transform hover:bg-red-200 flex items-center justify-center gap-2 text-sm" style="color: var(--color-expense);">
                        <i class="ph ph-trash text-lg"></i> Delete
                    </button>
                    <!-- Save Record Button -->
                    <button type="submit" class="flex-[2] text-white font-bold py-3.5 rounded-xl active:scale-95 transition-transform shadow-lg flex items-center justify-center gap-2 text-sm" style="background-color: var(--theme-main); box-shadow: 0 4px 6px -1px var(--theme-shadow);">
                        <i class="ph ph-check-circle text-lg"></i> Save
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- NEW CONFIRMATION MODAL -->
    <div id="confirmModal" class="fixed inset-0 z-[60] hidden">
        <div class="absolute inset-0 bg-black/40 backdrop-blur-sm transition-opacity"></div>
        <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 bg-white rounded-2xl p-5 w-72 shadow-2xl animate-pop-in text-center">
            <div class="w-10 h-10 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-3" style="color: var(--color-expense);">
                <i class="ph ph-warning-octagon text-xl"></i>
            </div>
            <h3 class="text-base font-bold text-gray-900 mb-1">Are you sure?</h3>
            <p class="text-xs text-gray-500 mb-5" id="confirmMessage">This action cannot be undone.</p>
            <div class="flex gap-2">
                <button onclick="closeConfirmModal()" class="flex-1 py-2.5 text-gray-600 font-bold bg-gray-100 rounded-xl hover:bg-gray-200 active:scale-95 transition-transform text-sm">Cancel</button>
                <button id="confirmBtnAction" class="flex-1 py-2.5 text-white font-bold rounded-xl hover:opacity-90 shadow-lg shadow-red-200 active:scale-95 transition-transform text-sm" style="background-color: var(--color-expense);">Yes, Delete</button>
            </div>
        </div>
    </div>

    <!-- NOTIFICATION -->
    <div id="toast" class="fixed top-6 left-1/2 -translate-x-1/2 bg-gray-900/90 backdrop-blur text-white px-5 py-2.5 rounded-full text-xs font-medium shadow-xl transform -translate-y-24 transition-all duration-500 z-[70] flex items-center gap-2">
        <i class="ph ph-check-circle text-green-400 text-lg"></i>
        <span>Saved successfully!</span>
    </div>

    <script>
        // --- DATA INITIALIZATION ---
        const INITIAL_DATA = [
];

        let transactions = JSON.parse(localStorage.getItem('myMoneyPlan')) || INITIAL_DATA;
        let appSettings = JSON.parse(localStorage.getItem('appSettings')) || { title: 'Money Plan', theme: 'blue', customColor: '#2563eb' };
        
        // --- THEME CONFIG ---
        const themes = {
            blue: { main: '#2563eb', light: '#3b82f6', dark: '#1d4ed8', shadow: '#bfdbfe', faint: '#dbeafe' },
            purple: { main: '#9333ea', light: '#a855f7', dark: '#7e22ce', shadow: '#e9d5ff', faint: '#f3e8ff' },
            green: { main: '#16a34a', light: '#22c55e', dark: '#15803d', shadow: '#bbf7d0', faint: '#dcfce7' },
            red: { main: '#dc2626', light: '#ef4444', dark: '#b91c1c', shadow: '#fecaca', faint: '#fee2e2' },
            orange: { main: '#ea580c', light: '#f97316', dark: '#c2410c', shadow: '#fed7aa', faint: '#ffedd5' },
            black: { main: '#18181b', light: '#52525b', dark: '#09090b', shadow: '#e4e4e7', faint: '#f4f4f5' }
        };

        let currentMonth = '';
        let chartInstance = null;

        // --- HELPER: COLOR MANIPULATION ---
        function hexToRgb(hex) {
            let r = 0, g = 0, b = 0;
            if (hex.length === 4) {
                r = parseInt("0x" + hex[1] + hex[1]);
                g = parseInt("0x" + hex[2] + hex[2]);
                b = parseInt("0x" + hex[3] + hex[3]);
            } else if (hex.length === 7) {
                r = parseInt("0x" + hex[1] + hex[2]);
                g = parseInt("0x" + hex[3] + hex[4]);
                b = parseInt("0x" + hex[5] + hex[6]);
            }
            return {r, g, b};
        }

        // Adjust brightness of a hex color (amt > 0 lighter, amt < 0 darker)
        function adjustBrightness(col, amt) {
            var usePound = false;
            if (col[0] == "#") {
                col = col.slice(1);
                usePound = true;
            }
            var num = parseInt(col,16);
            var r = (num >> 16) + amt;
            if (r > 255) r = 255; else if  (r < 0) r = 0;
            var b = ((num >> 8) & 0x00FF) + amt;
            if (b > 255) b = 255; else if  (b < 0) b = 0;
            var g = (num & 0x0000FF) + amt;
            if (g > 255) g = 255; else if (g < 0) g = 0;
            return (usePound?"#":"") + (g | (b << 8) | (r << 16)).toString(16).padStart(6,'0');
        }

        // --- CORE FUNCTIONS ---
        function init() {
            // Default to real-world current month
            const today = new Date();
            currentMonth = today.toISOString().slice(0, 7);

            applySettings(); // Apply theme & title
            renderMonthSelector();
            populateDataList(); 
            populateChartFilter();
            updateUI();

            // Listener for installment logic
            document.getElementById('inputInstTotal').addEventListener('input', updateInstallmentHint);
            document.getElementById('inputInstCurrent').addEventListener('input', updateInstallmentHint);
        }

        // --- SETTINGS LOGIC ---
        function openSettings() {
            document.getElementById('settingsTitle').value = appSettings.title;
            renderThemeSelector();
            document.getElementById('settingsModal').classList.remove('hidden');
        }

        function closeSettings() {
            document.getElementById('settingsModal').classList.add('hidden');
        }

        function renderThemeSelector() {
            const grid = document.getElementById('themeSelectorGrid');
            const predefined = Object.keys(themes).map(key => {
                const t = themes[key];
                const isSelected = appSettings.theme === key;
                return `
                    <div onclick="selectTheme('${key}')" class="cursor-pointer flex flex-col items-center gap-1">
                        <div class="w-10 h-10 rounded-full border-2 ${isSelected ? 'border-gray-800 scale-110' : 'border-transparent'} transition-transform" style="background-color: ${t.main}"></div>
                        <span class="text-[10px] uppercase font-bold text-gray-400">${key}</span>
                    </div>
                `;
            }).join('');

            // Add Custom Option
            const isCustom = appSettings.theme === 'custom';
            const customOption = `
                <div class="cursor-pointer flex flex-col items-center gap-1 relative">
                    <div class="w-10 h-10 rounded-full border-2 ${isCustom ? 'border-gray-800 scale-110' : 'border-transparent'} transition-transform bg-gradient-to-br from-pink-500 to-yellow-500 flex items-center justify-center">
                        <i class="ph ph-plus text-white font-bold"></i>
                    </div>
                    <span class="text-[10px] uppercase font-bold text-gray-400">Custom</span>
                    <input type="color" id="customColorPicker" class="absolute inset-0 opacity-0 cursor-pointer w-full h-full" 
                           value="${appSettings.customColor || '#000000'}" 
                           oninput="selectCustomTheme(this.value)">
                </div>
            `;

            grid.innerHTML = predefined + customOption;
        }

        function selectTheme(key) {
            appSettings.theme = key;
            renderThemeSelector(); // Re-render to show selection
        }

        function selectCustomTheme(color) {
            appSettings.theme = 'custom';
            appSettings.customColor = color;
            // Don't re-render entire grid to keep focus, just apply style preview if we wanted
            // For now, let's just update the app settings state
        }

        function saveSettings(e) {
            e.preventDefault();
            const newTitle = document.getElementById('settingsTitle').value;
            if(newTitle) appSettings.title = newTitle;
            
            localStorage.setItem('appSettings', JSON.stringify(appSettings));
            applySettings();
            closeSettings();
            showToast("Settings saved");
        }

        function applySettings() {
            // Update Title
            document.getElementById('appTitleDisplay').textContent = appSettings.title;
            document.title = appSettings.title;

            const root = document.documentElement;
            let t;

            if (appSettings.theme === 'custom') {
                const main = appSettings.customColor;
                const rgb = hexToRgb(main);
                t = {
                    main: main,
                    light: adjustBrightness(main, 40),  // Lighten by 40
                    dark: adjustBrightness(main, -20),  // Darken by 20
                    shadow: `rgba(${rgb.r}, ${rgb.g}, ${rgb.b}, 0.3)`,
                    faint: `rgba(${rgb.r}, ${rgb.g}, ${rgb.b}, 0.1)`
                };
            } else {
                t = themes[appSettings.theme];
            }

            // Apply Theme CSS Variables
            root.style.setProperty('--theme-main', t.main);
            root.style.setProperty('--theme-light', t.light);
            root.style.setProperty('--theme-dark', t.dark);
            root.style.setProperty('--theme-shadow', t.shadow);
            root.style.setProperty('--theme-faint', t.faint);

            // Re-render chart to pick up new colors
            if (chartInstance) renderChart();
        }

        // --- CSV IMPORT LOGIC ---
        function handleCSVUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                const text = e.target.result;
                const lines = text.split('\n');
                let count = 0;

                lines.forEach(line => {
                    // Skip empty lines or headers containing "Month" or "Subject"
                    const trimmedLine = line.trim();
                    if (!trimmedLine || trimmedLine.toLowerCase().includes('month') || trimmedLine.toLowerCase().includes('subject')) return;
                    
                    // Support both semicolon and comma, but semicolon is preferred based on your request
                    const delimiter = trimmedLine.includes(';') ? ';' : ',';
                    const parts = trimmedLine.split(delimiter);
                    
                    if (parts.length >= 3) {
                        let dateStr = parts[0].trim();
                        const desc = parts[1].trim();
                        // Remove any quotes if present and parse
                        const priceStr = parts[2].trim().replace(/["']/g, '');
                        const price = parseFloat(priceStr);

                        // Validate/Parse Date
                        let validDate = null;

                        // Case 1: Standard YYYY-MM (e.g. 2025-12)
                        if (/^\d{4}-\d{2}$/.test(dateStr)) {
                            validDate = dateStr;
                        } 
                        // Case 2: Short Month Name (e.g. Dec) -> Defaults to current year
                        else if (dateStr.length <= 3) {
                            const monthMap = { 'Jan': '01', 'Feb': '02', 'Mar': '03', 'Apr': '04', 'May': '05', 'Jun': '06', 'Jul': '07', 'Aug': '08', 'Sep': '09', 'Oct': '10', 'Nov': '11', 'Dec': '12' };
                            // Capitalize first letter just in case
                            const formattedMonth = dateStr.charAt(0).toUpperCase() + dateStr.slice(1).toLowerCase();
                            const m = monthMap[formattedMonth];
                            if (m) {
                                const y = new Date().getFullYear();
                                validDate = `${y}-${m}`;
                            }
                        }

                        if (validDate && !isNaN(price) && desc) {
                            transactions.push({
                                id: Date.now() + Math.random(),
                                date: validDate,
                                desc: desc,
                                category: 'Imported',
                                amount: Math.abs(price),
                                type: price < 0 ? 'expense' : 'income'
                            });
                            count++;
                        }
                    }
                });

                if (count > 0) {
                    saveData();
                    closeSettings();
                    showToast(`Imported ${count} records!`);
                } else {
                    alert("No valid records found.\nPlease use format: 2025-12; Car wash; -3000");
                }
            };
            reader.readAsText(file);
            // Reset input so same file can be selected again if needed
            event.target.value = '';
        }


        // --- HELPERS ---
        function populateDataList() {
            const dataList = document.getElementById('descSuggestions');
            const uniqueDescs = [...new Set(transactions.map(t => t.desc))];
            dataList.innerHTML = uniqueDescs.map(d => `<option value="${d}">`).join('');
        }

        function populateChartFilter() {
            const select = document.getElementById('chartFilterRange');
            const currentVal = select.value || 'last6';
            const years = [...new Set(transactions.map(t => t.date.split('-')[0]))].sort().reverse();
            
            let html = `
                <option value="last3">Last 3 Months</option>
                <option value="last6">Last 6 Months</option>
                <option value="last12">Last 12 Months</option>
            `;
            years.forEach(y => html += `<option value="${y}">${y}</option>`);
            select.innerHTML = html;
            
            if ([...select.options].some(o => o.value === currentVal)) select.value = currentVal;
            else select.value = 'last6';
        }

        function updateInstallmentHint() {
            const current = parseInt(document.getElementById('inputInstCurrent').value) || 0;
            const total = parseInt(document.getElementById('inputInstTotal').value) || 0;
            const hint = document.getElementById('autoGenHint');
            const countSpan = document.getElementById('genCount');
            const editId = document.getElementById('editId').value;

            if (!editId && total > 0 && current > 0 && total > current) {
                const remaining = total - current;
                countSpan.textContent = remaining;
                hint.classList.remove('hidden');
            } else {
                hint.classList.add('hidden');
            }
        }

        function autoFillCategory(input) {
            const val = input.value.toLowerCase();
            if(val.length < 2) return;
            const match = transactions.slice().reverse().find(t => t.desc.toLowerCase().includes(val));
            if (match) {
                if(match.category) document.getElementById('inputCategory').value = match.category;
                if(match.type) document.getElementById('inputType').value = match.type;
            }
        }

        function updateUI() {
            updateDashboard();
            renderList();
            renderChart();
            const [y, m] = currentMonth.split('-');
            const dateObj = new Date(y, m - 1);
            document.getElementById('currentDateDisplay').textContent = dateObj.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
            document.getElementById('filterDate').value = currentMonth;
        }

        function saveData() {
            localStorage.setItem('myMoneyPlan', JSON.stringify(transactions));
            populateDataList();
            populateChartFilter();
            updateUI();
        }

        // --- MODALS & CONFIRMATION ---
        let confirmCallback = null;

        function showConfirm(message, callback) {
            document.getElementById('confirmMessage').textContent = message;
            document.getElementById('confirmModal').classList.remove('hidden');
            confirmCallback = callback;
        }

        function closeConfirmModal() {
            document.getElementById('confirmModal').classList.add('hidden');
            confirmCallback = null;
        }

        document.getElementById('confirmBtnAction').addEventListener('click', () => {
            if (confirmCallback) confirmCallback();
            closeConfirmModal();
        });

        function triggerDelete() {
            const id = Number(document.getElementById('editId').value);
            const item = transactions.find(t => t.id === id);
            
            if (item && item.instTotal > 1) {
                // It's part of a series
                showConfirm(`This record is part of a series (Period ${item.instCurrent}/${item.instTotal}). Delete ALL periods?`, () => {
                    // Delete all related items in the series
                    transactions = transactions.filter(t => 
                        !(t.desc === item.desc && 
                          t.type === item.type && 
                          t.instTotal === item.instTotal &&
                          t.amount === item.amount) // strict matching to avoid accidents
                    );
                    saveData();
                    closeModal();
                    showToast("Series deleted");
                });
            } else {
                // Standard delete
                showConfirm("Are you sure you want to delete this record?", () => {
                    transactions = transactions.filter(t => t.id !== id);
                    saveData();
                    closeModal();
                    showToast("Record deleted");
                });
            }
        }

        // CHANGED: Clears only the current displayed month
        function triggerClearMonth() {
            const [y, m] = currentMonth.split('-');
            const dateObj = new Date(y, m - 1);
            const monthName = dateObj.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });

            showConfirm(`Delete ALL records for ${monthName}?`, () => {
                transactions = transactions.filter(t => t.date !== currentMonth);
                saveData();
                showToast("Month cleared");
            });
        }

        // --- DASHBOARD ---
        function renderMonthSelector() {
            // 1. Existing Data Months
            const dataMonths = new Set(transactions.map(t => t.date));
            
            // 2. Ensure Current Selection is in List (Fixing potential empty state bug)
            if (currentMonth) {
                dataMonths.add(currentMonth);
            }

            // 3. Sort
            const allMonths = [...dataMonths].sort();

            const select = document.getElementById('monthSelector');
            select.innerHTML = allMonths.map(m => {
                const [y, mo] = m.split('-');
                const date = new Date(y, mo-1);
                const name = date.toLocaleDateString('en-US', {month:'short', year:'2-digit'});
                return `<option value="${m}" ${m === currentMonth ? 'selected' : ''}>${name}</option>`;
            }).join('');
            
            // Ensure selector shows current month
            select.value = currentMonth;
        }

        function changeMonth() {
            currentMonth = document.getElementById('monthSelector').value;
            updateUI();
        }

        function updateDashboard() {
            const monthData = transactions.filter(t => t.date === currentMonth);
            const income = monthData.filter(t => t.type === 'income').reduce((sum, t) => sum + t.amount, 0);
            const expenses = monthData.filter(t => t.type === 'expense').reduce((sum, t) => sum + t.amount, 0);
            const leftover = income - expenses;

            // Total All Time Calc
            const totalIncome = transactions.filter(t => t.type === 'income').reduce((sum, t) => sum + t.amount, 0);
            const totalExpense = transactions.filter(t => t.type === 'expense').reduce((sum, t) => sum + t.amount, 0);
            const totalBalance = totalIncome - totalExpense;

            document.getElementById('dashIncome').textContent = '+' + income.toLocaleString();
            document.getElementById('dashExpenses').textContent = '-' + expenses.toLocaleString();
            document.getElementById('dashTotalBalance').textContent = totalBalance.toLocaleString();
            
            const leftEl = document.getElementById('dashLeftover');
            leftEl.textContent = leftover.toLocaleString();
            
            if(leftover < 0) {
                 leftEl.classList.remove('text-white');
                 leftEl.classList.add('text-red-200');
            } else {
                 leftEl.classList.remove('text-red-200');
                 leftEl.classList.add('text-white');
            }

            const topExpenses = monthData.filter(t => t.type === 'expense').sort((a, b) => b.amount - a.amount).slice(0, 3);
            const listEl = document.getElementById('dashboardList');
            if (topExpenses.length === 0) {
                listEl.innerHTML = `<div class="ios-card p-4 text-center"><p class="text-gray-400 text-sm">No expenses this month yet.</p></div>`;
            } else {
                listEl.innerHTML = topExpenses.map(item => `
                    <div class="ios-card p-4 flex justify-between items-center border-l-4 border-[var(--theme-light)]/50">
                        <div class="flex items-center gap-3">
                            <div class="w-8 h-8 rounded-full bg-[var(--theme-faint)] flex items-center justify-center text-[var(--theme-main)]">
                                <i class="ph ph-shopping-cart"></i>
                            </div>
                            <p class="font-bold text-sm text-gray-800">${item.desc}</p>
                        </div>
                        <span class="font-bold text-gray-700">-${item.amount.toLocaleString()}</span>
                    </div>
                `).join('');
            }
        }

        function renderChart() {
            // Get computed style for CSS variables
            const rootStyle = getComputedStyle(document.documentElement);
            const themeLight = rootStyle.getPropertyValue('--theme-light').trim();
            const colorExpense = rootStyle.getPropertyValue('--color-expense').trim();

            const ctx = document.getElementById('trendChart').getContext('2d');
            const rangeFilter = document.getElementById('chartFilterRange').value; 
            const typeFilter = document.getElementById('chartFilterType').value;
            const allMonths = [...new Set(transactions.map(t => t.date))].sort();
            let displayMonths = [];

            if (rangeFilter === 'last3') displayMonths = allMonths.slice(-3);
            else if (rangeFilter === 'last6') displayMonths = allMonths.slice(-6);
            else if (rangeFilter === 'last12') displayMonths = allMonths.slice(-12);
            else displayMonths = allMonths.filter(m => m.startsWith(rangeFilter));

            const labels = displayMonths.map(m => {
                const [y, mo] = m.split('-');
                return new Date(y, mo-1).toLocaleDateString('en-US', {month:'short'}); 
            });

            const incomeData = displayMonths.map(m => transactions.filter(t => t.date === m && t.type === 'income').reduce((sum, t) => sum + t.amount, 0));
            const expenseData = displayMonths.map(m => transactions.filter(t => t.date === m && t.type === 'expense').reduce((sum, t) => sum + t.amount, 0));

            const datasets = [];
            if (typeFilter === 'both' || typeFilter === 'income') {
                datasets.push({ label: 'Income', data: incomeData, backgroundColor: themeLight, borderRadius: 4, barPercentage: 0.7, categoryPercentage: 0.8 });
            }
            if (typeFilter === 'both' || typeFilter === 'expense') {
                datasets.push({ label: 'Expenses', data: expenseData, backgroundColor: colorExpense, borderRadius: 4, barPercentage: 0.7, categoryPercentage: 0.8 });
            }

            if (chartInstance) chartInstance.destroy();
            chartInstance = new Chart(ctx, {
                type: 'bar',
                data: { labels: labels, datasets: datasets },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    plugins: { legend: { display: true, position: 'bottom', labels: { boxWidth: 10 } } },
                    scales: {
                        y: { beginAtZero: true, grid: { color: '#f3f4f6', drawBorder: false }, ticks: { font: { size: 10 }, color: '#9ca3af', callback: function(value) { return value >= 1000 ? value/1000 + 'k' : value; } } },
                        x: { grid: { display: false }, ticks: { font: { size: 10 }, color: '#6b7280' } }
                    }
                }
            });
        }

        function applyListFilters() {
            const dateVal = document.getElementById('filterDate').value;
            // Check if month changed
            if (dateVal !== currentMonth) {
                // IMPORTANT: Ensure the selected month is in the dropdown before switching
                const select = document.getElementById('monthSelector');
                // Check if options contain the value
                let exists = false;
                for (let i = 0; i < select.options.length; i++) {
                    if (select.options[i].value === dateVal) {
                        exists = true;
                        break;
                    }
                }
                
                // If it doesn't exist (because renderMonthSelector relies on currentMonth being set or data present)
                // We set currentMonth first, then update UI (which re-renders selector)
                currentMonth = dateVal;
                updateUI(); 
            } else {
                renderList();
            }
        }

        function renderList() {
            const listEl = document.getElementById('fullList');
            const typeFilter = document.getElementById('filterType').value;
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();

            let items = transactions.filter(t => t.date === currentMonth);
            if (typeFilter !== 'all') items = items.filter(t => t.type === typeFilter);
            if (searchTerm) items = items.filter(t => t.desc.toLowerCase().includes(searchTerm) || (t.category && t.category.toLowerCase().includes(searchTerm)));

            items.sort((a, b) => b.amount - a.amount);
            
            if (items.length === 0) {
                listEl.innerHTML = `<div class="flex flex-col items-center justify-center pt-10 opacity-50"><i class="ph ph-receipt text-4xl mb-2"></i><p>No records found</p></div>`;
                return;
            }

            listEl.innerHTML = items.map(item => `
                <div class="bg-white p-2.5 rounded-xl shadow-sm flex justify-between items-center cursor-pointer active:scale-[0.99] transition-transform duration-100 border border-gray-100" onclick="editItem(${item.id})">
                    <div class="flex items-center gap-4">
                        <div class="w-9 h-9 rounded-full flex items-center justify-center flex-shrink-0 ${item.type === 'income' ? 'text-[var(--color-income)] bg-[var(--color-income-bg)]' : 'text-[var(--color-expense)] bg-[var(--color-expense-bg)]'}">
                            <i class="ph ${item.type === 'income' ? 'ph-arrow-down-left' : 'ph-arrow-up-right'} text-lg font-bold"></i>
                        </div>
                        <div class="min-w-0">
                            <p class="font-bold text-gray-800 text-sm truncate">${item.desc}</p>
                            <div class="flex flex-wrap items-center gap-1.5 mt-0.5">
                                ${item.category ? `<span class="text-[10px] bg-gray-100 text-gray-500 px-1.5 py-0.5 rounded-md font-medium truncate max-w-[80px]">${item.category}</span>` : ''}
                                ${item.instTotal ? `<span class="text-[10px] bg-[var(--theme-faint)] text-[var(--theme-main)] px-1.5 py-0.5 rounded-md font-bold">${item.instCurrent}/${item.instTotal}</span>` : ''}
                                <span class="text-[10px] text-gray-400 capitalize font-medium">${item.type}</span>
                            </div>
                        </div>
                    </div>
                    <div class="text-right flex-shrink-0 pl-2">
                        <p class="font-bold text-base ${item.type === 'income' ? 'text-[var(--color-income)]' : 'text-[var(--color-expense)]'}">
                            ${item.type === 'expense' ? '-' : '+'}${item.amount.toLocaleString()}
                        </p>
                    </div>
                </div>
            `).join('');
        }

        function switchTab(tab) {
            document.querySelectorAll('[id^="view-"]').forEach(el => el.classList.add('hidden'));
            document.getElementById(`view-${tab}`).classList.remove('hidden');
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active', 'text-gray-400'));
            const navId = tab === 'dashboard' ? 'nav-dash' : 'nav-list';
            document.getElementById(navId).classList.add('active');
            if(tab === 'list') renderList();
            document.getElementById('mainContainer').scrollTop = 0;
        }

        function openModal(id = null) {
            const modal = document.getElementById('modal');
            modal.classList.remove('hidden');
            document.getElementById('editId').value = '';
            document.getElementById('inputDate').value = currentMonth;
            document.getElementById('inputDesc').value = '';
            document.getElementById('inputAmount').value = '';
            document.getElementById('inputCategory').value = '';
            document.getElementById('inputInstCurrent').value = '';
            document.getElementById('inputInstTotal').value = '';
            document.getElementById('inputType').value = 'expense';
            document.getElementById('autoGenHint').classList.add('hidden');
            const deleteBtn = document.getElementById('deleteBtn');
            const modalTitle = document.getElementById('modalTitle');

            if (id) {
                const item = transactions.find(t => t.id === id);
                if (item) {
                    document.getElementById('editId').value = item.id;
                    document.getElementById('inputDate').value = item.date;
                    document.getElementById('inputDesc').value = item.desc;
                    document.getElementById('inputCategory').value = item.category || '';
                    document.getElementById('inputAmount').value = item.amount;
                    document.getElementById('inputType').value = item.type;
                    document.getElementById('inputInstCurrent').value = item.instCurrent || '';
                    document.getElementById('inputInstTotal').value = item.instTotal || '';
                }
                deleteBtn.classList.remove('hidden'); 
                modalTitle.textContent = "Edit Record";
            } else {
                deleteBtn.classList.add('hidden');
                modalTitle.textContent = "Add New Record";
            }
        }

        function closeModal() { document.getElementById('modal').classList.add('hidden'); }

        function saveTransaction(e) {
            e.preventDefault();
            const id = document.getElementById('editId').value;
            const date = document.getElementById('inputDate').value;
            const desc = document.getElementById('inputDesc').value;
            const category = document.getElementById('inputCategory').value;
            const amount = parseFloat(document.getElementById('inputAmount').value);
            const type = document.getElementById('inputType').value;
            const instCurrent = parseInt(document.getElementById('inputInstCurrent').value) || null;
            const instTotal = parseInt(document.getElementById('inputInstTotal').value) || null;

            if (!id) {
                const newId = Date.now();
                transactions.push({ id: newId, date, desc, category, amount, type, instCurrent, instTotal });
                if (instCurrent && instTotal && instTotal > instCurrent) {
                    let nextMonthDate = new Date(date + '-01'); 
                    let currentCount = instCurrent;
                    while (currentCount < instTotal) {
                        currentCount++;
                        nextMonthDate.setMonth(nextMonthDate.getMonth() + 1);
                        const y = nextMonthDate.getFullYear();
                        const m = String(nextMonthDate.getMonth() + 1).padStart(2, '0');
                        transactions.push({
                            id: Date.now() + currentCount, date: `${y}-${m}`, desc: desc, category: category, amount: amount, type: type, instCurrent: currentCount, instTotal: instTotal
                        });
                    }
                    showToast(`Generated ${instTotal - instCurrent} future records!`);
                }
            } else {
                const idx = transactions.findIndex(t => t.id == id);
                if (idx > -1) transactions[idx] = { id: Number(id), date, desc, category, amount, type, instCurrent, instTotal };
            }
            currentMonth = date;
            closeModal();
            saveData();
            renderMonthSelector();
            if(!id && (!instTotal || instTotal <= instCurrent)) showToast("Record saved");
        }

        function editItem(id) { openModal(id); }

        function showToast(msg = "Saved successfully!") {
            const t = document.getElementById('toast');
            t.querySelector('span').textContent = msg;
            t.classList.remove('-translate-y-24');
            t.classList.add('translate-y-4');
            setTimeout(() => { t.classList.remove('translate-y-4'); t.classList.add('-translate-y-24'); }, 3000);
        }

        window.addEventListener('load', init);
    </script>
</body>
</html>
